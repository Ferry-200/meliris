<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå£°èƒ½é‡æ ‡æ³¨å·¥å…· (Vocal Energy Labeler)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Solarized Light Palette */
        /* base3: #fdf6e3 | base2: #eee8d5 | base1: #93a1a1 | base0: #839496 | base00: #657b83 */
        /* red: #dc322f | blue: #268bd2 | cyan: #2aa198 | green: #859900 | yellow: #b58900 */

        body {
            /* Solarized Base 3 */
            background-color: #fdf6e3; 
            /* Solarized Base 00 */
            color: #657b83;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; 
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ - Light theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #eee8d5; /* base2 */
        }
        ::-webkit-scrollbar-thumb {
            background: #93a1a1; /* base1 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #839496; /* base0 */
        }

        .canvas-container {
            position: relative;
            width: 100%;
            /* 30 (Ruler) + 150 (Energy) + 50 (Label) = 230px */
            height: 230px; 
            /* Solarized Base 2 */
            background: #eee8d5;
            /* Solarized Base 0 */
            border: 1px solid #839496;
            overflow-x: auto;
            overflow-y: hidden;
            cursor: crosshair;
        }

        canvas {
            display: block;
        }

        /* æ’­æ”¾æŒ‡é’ˆæ ·å¼ */
        #playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            /* Solarized Red */
            background-color: #dc322f; 
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        .control-group {
            /* Solarized Base 1 */
            background: #eee8d5;
            padding: 1rem;
            border-radius: 0.5rem;
            /* Solarized Base 0 */
            border: 1px solid #839496;
        }

        /* --- æ»‘å—æ ·å¼ --- */
        input[type=range] {
            -webkit-appearance: none; /* æ¸…é™¤é»˜è®¤æ ·å¼ */
            width: 100%;
            background: transparent;
            margin: 8px 0;
        }

        input[type=range]:focus {
            outline: none;
        }

        /* WebKit (Chrome, Edge, Safari) æ»‘å—è½¨é“ */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            /* Solarized Base 01 */
            background: #586e75; 
            border-radius: 3px;
        }

        /* WebKit æ»‘å—æ‹‡æŒ‡ - é»˜è®¤ (é˜ˆå€¼) */
        input[type=range]::-webkit-slider-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            /* Solarized Yellow (Threshold) */
            background: #b58900; 
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Firefox æ»‘å—è½¨é“ */
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #586e75; /* Solarized Base 01 */
            border-radius: 3px;
        }

        /* Firefox æ»‘å—æ‹‡æŒ‡ */
        input[type=range]::-moz-range-thumb {
            height: 18px;
            width: 18px;
            border: none;
            border-radius: 50%;
            background: #b58900; /* Solarized Yellow */
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        /* é’ˆå¯¹å¹³æ»‘æ»‘å—çš„ç‰¹æ®Šæ ·å¼è¦†ç›– (Cyan) */
        input#smoothSlider::-webkit-slider-thumb {
            background: #2aa198; /* Solarized Cyan */
        }
        input#smoothSlider::-moz-range-thumb {
            background: #2aa198;
        }

        /* é’ˆå¯¹ç¼©æ”¾æ»‘å—çš„ç‰¹æ®Šæ ·å¼è¦†ç›– (Green) */
        input#zoomSlider::-webkit-slider-thumb {
            background: #859900; /* Solarized Green */
        }
        input#zoomSlider::-moz-range-thumb {
            background: #859900;
        }

    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <header class="p-4 bg-[#eee8d5] border-b border-[#839496] flex justify-between items-center shadow-md z-20">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-[#268bd2]">ğŸ¤ Vocal Labeler</h1>
            
            <!-- æ–‡ä»¶è¾“å…¥ -->
            <div class="flex space-x-2">
                <label class="px-3 py-1.5 bg-[#268bd2] hover:bg-[#2aa198] rounded cursor-pointer text-sm transition text-[#fdf6e3]">
                    ğŸ“‚ æ‰“å¼€æ–‡ä»¶
                    <input type="file" id="fileInput" accept="audio/*" class="hidden">
                </label>
                <label class="px-3 py-1.5 bg-[#93a1a1] hover:bg-[#839496] rounded cursor-pointer text-sm transition text-[#fdf6e3]">
                    ğŸ“‚ æ‰“å¼€æ–‡ä»¶å¤¹
                    <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden">
                </label>
            </div>
            
            <!-- å½“å‰æ–‡ä»¶æ˜¾ç¤º -->
            <div id="currentFileInfo" class="text-sm text-[#657b83] max-w-xs truncate">
                æœªé€‰æ‹©æ–‡ä»¶
            </div>
        </div>

        <div class="flex items-center space-x-3">
             <button id="exportBtn" class="px-4 py-1.5 bg-[#859900] hover:bg-[#b58900] rounded text-[#fdf6e3] text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition">
                â¬‡ï¸ å¯¼å‡ºæ ‡ç­¾
            </button>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- å·¦ä¾§ï¼šæ–‡ä»¶åˆ—è¡¨ -->
        <aside class="w-64 bg-[#eee8d5] border-r border-[#839496] flex flex-col hidden text-[#657b83]" id="playlistPanel">
            <div class="p-2 text-xs font-bold text-[#657b83] uppercase tracking-wider bg-[#fdf6e3]">æ–‡ä»¶åˆ—è¡¨</div>
            <ul id="fileList" class="flex-1 overflow-y-auto text-sm">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ—è¡¨é¡¹ -->
            </ul>
        </aside>

        <!-- å³ä¾§ï¼šå¯è§†åŒ–ç¼–è¾‘å™¨ -->
        <section class="flex-1 flex flex-col relative">
            
            <!-- å‚æ•°æ§åˆ¶é¢æ¿ - è°ƒæ•´ä¸º 4 åˆ— -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-[#fdf6e3] border-b border-[#839496]">
                
                <!-- é˜ˆå€¼æ§åˆ¶ (Col 1) -->
                <div class="control-group flex flex-col justify-center">
                    <div class="flex justify-between mb-1">
                        <label class="text-xs text-[#586e75]">èƒ½é‡é˜ˆå€¼ (Threshold)</label>
                        <span id="thresholdVal" class="text-xs font-mono text-[#b58900]">-40 dB</span>
                    </div>
                    <input type="range" id="thresholdSlider" min="-80" max="0" value="-40" step="1">
                </div>

                <!-- å¹³æ»‘æ§åˆ¶ (Col 2) -->
                <div class="control-group flex flex-col justify-center">
                    <div class="flex justify-between mb-1">
                        <label class="text-xs text-[#586e75]">å¹³æ»‘çª—å£ (Smoothing)</label>
                        <span id="smoothVal" class="text-xs font-mono text-[#2aa198]">50 ms</span>
                    </div>
                    <input type="range" id="smoothSlider" min="10" max="500" value="50" step="10">
                </div>
                
                <!-- ç¼©æ”¾æ§åˆ¶ (Col 3) -->
                <div class="control-group flex flex-col justify-center">
                    <div class="flex justify-between mb-1">
                        <label class="text-xs text-[#586e75]">ç¼©æ”¾ (Zoom)</label>
                        <span id="zoomVal" class="text-xs font-mono text-[#859900]">100 px/s</span>
                    </div>
                    <input type="range" id="zoomSlider" min="20" max="500" value="100" step="10">
                </div>
                
                <!-- æ’­æ”¾æ§åˆ¶ (Col 4) -->
                <div class="control-group flex items-center justify-between">
                     <div class="flex items-center space-x-2">
                        <button id="playPauseBtn" class="w-10 h-10 rounded-full bg-[#eee8d5] text-[#586e75] flex items-center justify-center hover:scale-105 transition disabled:opacity-50">
                            â–¶
                        </button>
                        <div class="text-xs font-mono">
                            <span id="currentTime" class="text-[#586e75]">00:00.00</span> / 
                            <span id="totalTime" class="text-[#839496]">00:00.00</span>
                        </div>
                     </div>
                     <div class="text-xs text-[#839496] text-right">
                        <p>å·¦é”®æ‹–æ‹½: <span class="text-[#cb4b16]">äººå£°</span></p>
                        <p>Shift+æ‹–æ‹½: <span class="text-[#93a1a1]">é—´å¥</span></p>
                     </div>
                </div>
            </div>

            <!-- ç”»å¸ƒå®¹å™¨ -->
            <div class="flex-1 bg-[#fdf6e3] relative overflow-hidden flex flex-col justify-center items-center" id="workspace">
                <div id="loadingOverlay" class="absolute inset-0 bg-[#fdf6e3]/90 z-50 flex items-center justify-center hidden">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#268bd2] mx-auto mb-4"></div>
                        <p class="text-[#268bd2] animate-pulse">æ­£åœ¨å¤„ç†éŸ³é¢‘...</p>
                    </div>
                </div>

                <div id="introText" class="text-[#586e75] text-lg">
                    è¯·å¯¼å…¥éŸ³é¢‘æ–‡ä»¶å¼€å§‹åˆ†æ
                </div>

                <div id="canvasWrapper" class="canvas-container hidden">
                    <!-- å°ºå­ç”»å¸ƒ (Ruler Canvas) -->
                    <canvas id="rulerCanvas" height="30" class="absolute top-0 left-0 z-20"></canvas>
                    <!-- èƒ½é‡ç”»å¸ƒ (Energy Canvas) -->
                    <canvas id="energyCanvas" height="150" class="absolute top-[30px] left-0 z-0"></canvas>
                    <!-- æ ‡ç­¾ç”»å¸ƒ (Label Canvas) -->
                    <canvas id="labelCanvas" height="50" class="absolute top-[180px] left-0 z-10 opacity-80"></canvas>
                    <!-- æ’­æ”¾å¤´ (Playhead) -->
                    <div id="playhead"></div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å›¾ä¾‹ -->
            <div class="h-6 bg-[#eee8d5] border-t border-[#839496] flex items-center px-4 text-xs space-x-4">
                <div class="flex items-center"><div class="w-3 h-3 bg-[#268bd2]/30 border border-[#268bd2] mr-1"></div> èƒ½é‡æ›²çº¿ (RMS)</div>
                <div class="flex items-center"><div class="w-3 h-3 bg-[#b58900]/80 mr-1"></div> èƒ½é‡é˜ˆå€¼çº¿</div>
                <div class="flex items-center"><div class="w-3 h-3 bg-[#cb4b16]/60 mr-1"></div> äººå£°æ ‡ç­¾ (1)</div>
                <div class="flex items-center"><div class="w-3 h-3 bg-[#93a1a1] mr-1"></div> é—´å¥æ ‡ç­¾ (0)</div>
            </div>

        </section>
    </main>

    <script>
        // --- å…¨å±€å˜é‡ ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let audioBuffer = null;
        let audioSource = null;
        let isPlaying = false;
        let startTime = 0;
        let pauseTime = 0;
        
        // æ•°æ®ç›¸å…³
        let rawEnergyData = []; // åŸå§‹ RMS æ•°æ®
        let smoothedEnergyData = []; // å¹³æ»‘å RMS æ•°æ®
        let binaryLabels = []; // 0 æˆ– 1
        let sampleRate = 44100;
        let dataStep = 0; // æ¯ä¸ªæ•°æ®ç‚¹ä»£è¡¨çš„ç§’æ•°
        
        // çŠ¶æ€ç›¸å…³
        let thresholdDb = -40;
        let smoothingMs = 50;
        let pixelsPerSecond = 100; // NEW: é»˜è®¤ç¼©æ”¾çº§åˆ« (æ¯ç§’åƒç´ æ•°)
        let currentFileIndex = -1;
        let fileList = [];
        
        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const rulerCanvas = document.getElementById('rulerCanvas'); // NEW
        const energyCanvas = document.getElementById('energyCanvas');
        const labelCanvas = document.getElementById('labelCanvas');
        const playhead = document.getElementById('playhead');
        
        const ctxRuler = rulerCanvas.getContext('2d'); // NEW
        const ctxEnergy = energyCanvas.getContext('2d');
        const ctxLabel = labelCanvas.getContext('2d');
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const introText = document.getElementById('introText');
        const playlistPanel = document.getElementById('playlistPanel');
        const fileListUl = document.getElementById('fileList');
        
        // æ»‘å—
        const thresholdSlider = document.getElementById('thresholdSlider');
        const smoothSlider = document.getElementById('smoothSlider');
        const zoomSlider = document.getElementById('zoomSlider'); // NEW
        
        // åˆå§‹åŒ–å°ºå¯¸
        function resizeCanvases(width) {
            rulerCanvas.width = width; // NEW
            energyCanvas.width = width;
            labelCanvas.width = width;
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        folderInput.addEventListener('change', (e) => handleFiles(e.target.files));

        thresholdSlider.addEventListener('input', (e) => {
            thresholdDb = parseInt(e.target.value);
            document.getElementById('thresholdVal').textContent = thresholdDb + " dB";
            updateLabelsFromThreshold();
            drawAll();
        });

        smoothSlider.addEventListener('input', (e) => {
            smoothingMs = parseInt(e.target.value);
            document.getElementById('smoothVal').textContent = smoothingMs + " ms";
            if(audioBuffer) processAudioData(); // é‡æ–°è®¡ç®—å¹³æ»‘
        });
        
        // NEW: ç¼©æ”¾æ»‘å—äº‹ä»¶
        zoomSlider.addEventListener('input', (e) => {
            pixelsPerSecond = parseInt(e.target.value);
            document.getElementById('zoomVal').textContent = pixelsPerSecond + " px/s";
            if (audioBuffer) {
                // ä»…æ›´æ–°å®½åº¦å’Œé‡ç»˜ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—èƒ½é‡æ•°æ®
                const totalWidth = Math.max(canvasWrapper.clientWidth, Math.ceil(audioBuffer.duration * pixelsPerSecond));
                resizeCanvases(totalWidth);
                drawAll();
                updatePlayheadPosition(pauseTime); // ç¼©æ”¾åæ’­æ”¾å¤´ä½ç½®éœ€è¦æ›´æ–°
            }
        });


        document.getElementById('playPauseBtn').addEventListener('click', togglePlay);
        document.getElementById('exportBtn').addEventListener('click', exportLabels);

        // --- æ–‡ä»¶å¤„ç† (ç•¥) ---

        function handleFiles(files) {
            if (files.length === 0) return;
            
            // è¿‡æ»¤éŸ³é¢‘æ–‡ä»¶
            fileList = Array.from(files).filter(f => f.type.startsWith('audio/') || f.name.endsWith('.wav') || f.name.endsWith('.mp3') || f.name.endsWith('.flac'));
            
            if (fileList.length === 0) {
                // ä½¿ç”¨ console.error ä»£æ›¿ alert
                console.error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶");
                return;
            }

            // æ›´æ–°æ’­æ”¾åˆ—è¡¨UI
            renderPlaylist();
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œéšè—åˆ—è¡¨ï¼Œç›´æ¥åŠ è½½ã€‚å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œæ˜¾ç¤ºåˆ—è¡¨ã€‚
            if (fileList.length > 1) {
                playlistPanel.classList.remove('hidden');
            } else {
                playlistPanel.classList.add('hidden');
            }

            loadFile(0); // åŠ è½½ç¬¬ä¸€ä¸ª
        }

        function renderPlaylist() {
            fileListUl.innerHTML = '';
            fileList.forEach((file, index) => {
                const li = document.createElement('li');
                // Solarized Base 00 Text, Violet Background for selected
                li.className = `p-2 cursor-pointer hover:bg-[#839496] truncate ${index === currentFileIndex ? 'bg-[#6c71c4] text-[#fdf6e3]' : 'text-[#657b83]'}`;
                li.textContent = file.name;
                li.onclick = () => loadFile(index);
                fileListUl.appendChild(li);
            });
        }

        async function loadFile(index) {
            if (index < 0 || index >= fileList.length) return;
            
            stopAudio();
            currentFileIndex = index;
            renderPlaylist(); // æ›´æ–°é«˜äº®
            
            const file = fileList[index];
            document.getElementById('currentFileInfo').textContent = file.name;
            introText.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');
            canvasWrapper.classList.add('hidden');

            try {
                const arrayBuffer = await file.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                sampleRate = audioBuffer.sampleRate;
                
                processAudioData();
                
                canvasWrapper.classList.remove('hidden');
                document.getElementById('totalTime').textContent = formatTime(audioBuffer.duration);
                // å¯ç”¨æŒ‰é’®
                document.getElementById('playPauseBtn').disabled = false;
                document.getElementById('exportBtn').disabled = false;
            } catch (err) {
                console.error("éŸ³é¢‘è§£ç å¤±è´¥: ", err.message);
                // æ›´å¥½çš„é”™è¯¯æç¤º
                document.getElementById('introText').textContent = `éŸ³é¢‘è§£ç å¤±è´¥: ${err.message}`;
                document.getElementById('introText').classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šèƒ½é‡è®¡ç®— ---

        function processAudioData() {
            if (!audioBuffer) return;

            const rawData = audioBuffer.getChannelData(0); // åªå–å•å£°é“
            const windowSize = Math.floor((smoothingMs / 1000) * sampleRate);
            dataStep = smoothingMs / 1000; // æ¯ä¸ªç‚¹çš„æ—¶é•¿ (ç§’)
            
            rawEnergyData = [];
            
            // è®¡ç®— RMS
            for (let i = 0; i < rawData.length; i += windowSize) {
                let sum = 0;
                // é˜²æ­¢è¾¹ç•Œæº¢å‡º
                const end = Math.min(i + windowSize, rawData.length);
                const count = end - i;
                
                for (let j = i; j < end; j++) {
                    sum += rawData[j] * rawData[j];
                }
                const rms = Math.sqrt(sum / count);
                // è½¬æ¢ä¸º dB: 20 * log10(rms). é˜²æ­¢ log(0)
                const db = rms > 0.000001 ? 20 * Math.log10(rms) : -100;
                rawEnergyData.push(db);
            }

            // å¯ä»¥åœ¨è¿™é‡ŒåŠ é¢å¤–çš„å¹³æ»‘ï¼Œä½† RMS æœ¬èº«å°±æ˜¯ä¸€ç§å¹³æ»‘ã€‚æˆ‘ä»¬ç›´æ¥ç”¨è¿™ä¸ªæ•°æ®ã€‚
            smoothedEnergyData = rawEnergyData; 

            // è®¾ç½®ç”»å¸ƒå®½åº¦ï¼šæ¯ç§’ pixelsPerSecond åƒç´ ï¼Œæˆ–è€…é€‚é…å±å¹•ï¼Œè¿™é‡Œåšæˆæ¨ªå‘æ»šåŠ¨
            // ä½¿ç”¨å…¨å±€çš„ pixelsPerSecond å˜é‡
            const totalWidth = Math.max(canvasWrapper.clientWidth, Math.ceil(audioBuffer.duration * pixelsPerSecond));
            
            resizeCanvases(totalWidth);
            updateLabelsFromThreshold();
            drawAll();
            document.getElementById('zoomVal').textContent = pixelsPerSecond + " px/s"; // ç¡®ä¿åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæ­£ç¡®
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šæ ‡ç­¾ç”Ÿæˆ (ç•¥) ---

        function updateLabelsFromThreshold() {
            // æ ¹æ®é˜ˆå€¼é‡æ–°ç”Ÿæˆæ ‡ç­¾ï¼Œä½†ä¸è¦†ç›–ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹è¿‡çš„åŒºåŸŸï¼Ÿ
            // ç®€å•èµ·è§ï¼Œæ‹–åŠ¨æ»‘å—ä¼šé‡ç½®æ‰€æœ‰æ ‡ç­¾ã€‚å¦‚æœè¦åšå¤æ‚æ’¤é”€ï¼Œéœ€è¦å†å²æ ˆã€‚
            // è¿™é‡Œæˆ‘ä»¬åšå…¨é‡æ›´æ–°ã€‚
            binaryLabels = smoothedEnergyData.map(db => db > thresholdDb ? 1 : 0);
        }

        // --- ç»˜å›¾é€»è¾‘ ---

        function drawAll() {
            drawRuler(); // NEW: ç»˜åˆ¶å°ºå­
            drawEnergy();
            drawLabels();
        }
        
        // NEW: ç»˜åˆ¶å°ºå­
        function drawRuler() {
            const w = rulerCanvas.width;
            const h = rulerCanvas.height;
            ctxRuler.clearRect(0, 0, w, h);
            // Solarized Base 1
            ctxRuler.fillStyle = "#eee8d5"; 
            ctxRuler.fillRect(0, 0, w, h);

            if (!audioBuffer) return;

            const duration = audioBuffer.duration;
            let majorInterval = 1; // é»˜è®¤æ¯ 1 ç§’ä¸€ä¸ªä¸»åˆ»åº¦
            
            // æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´åˆ»åº¦å¯†åº¦
            if (pixelsPerSecond < 40) majorInterval = 5;
            else if (pixelsPerSecond < 80) majorInterval = 2;
            else if (pixelsPerSecond > 200) majorInterval = 0.5;
            
            // Solarized Base 0
            ctxRuler.strokeStyle = "#839496"; 
            ctxRuler.fillStyle = "#839496";
            ctxRuler.font = "10px Inter, sans-serif";
            ctxRuler.textAlign = "center";
            ctxRuler.textBaseline = "middle";

            for (let t = 0; t <= duration + majorInterval; t += majorInterval) {
                const x = t * pixelsPerSecond;
                if (x > w) break;

                // Major Tick
                ctxRuler.beginPath();
                ctxRuler.moveTo(x, h);
                ctxRuler.lineTo(x, h - 10);
                ctxRuler.stroke();
                
                // Time Label
                ctxRuler.fillText(formatTime(t), x, h - 18);
                
                // Minor Ticks (only if zoom is high enough to see them)
                if (majorInterval >= 1) {
                    for (let minor = 1; minor < 5; minor++) {
                        const minorTime = t + (majorInterval / 5) * minor;
                        if (minorTime < duration) {
                            const minorX = minorTime * pixelsPerSecond;
                            // æ£€æŸ¥æ˜¯å¦åœ¨ä¸‹ä¸€ä¸ªä¸»åˆ»åº¦ä¹‹å‰
                            if (minorX < (t + majorInterval) * pixelsPerSecond) {
                                ctxRuler.beginPath();
                                ctxRuler.moveTo(minorX, h);
                                ctxRuler.lineTo(minorX, h - 5);
                                ctxRuler.stroke();
                            }
                        }
                    }
                }
            }
        }


        function drawEnergy() {
            const w = energyCanvas.width;
            const h = energyCanvas.height;
            ctxEnergy.clearRect(0, 0, w, h);

            // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
            // Solarized Base 2
            ctxEnergy.fillStyle = "#eee8d5"; 
            ctxEnergy.fillRect(0, 0, w, h);
            // Solarized Base 0
            ctxEnergy.strokeStyle = "#839496"; 
            ctxEnergy.beginPath();
            ctxEnergy.moveTo(0, h/2);
            ctxEnergy.lineTo(w, h/2);
            ctxEnergy.stroke();

            // æ˜ å°„ dB åˆ° Y è½´ã€‚èŒƒå›´ -80dB (åº•éƒ¨) åˆ° 0dB (é¡¶éƒ¨)
            // y = h - ( (db + 80) / 80 * h )
            const mapY = (db) => {
                let norm = (db + 80) / 80;
                if (norm < 0) norm = 0;
                if (norm > 1) norm = 1;
                return h - (norm * h);
            };

            // ç»˜åˆ¶é˜ˆå€¼çº¿
            const threshY = mapY(thresholdDb);
            // Solarized Yellow
            ctxEnergy.strokeStyle = "#b58900"; 
            ctxEnergy.lineWidth = 1;
            ctxEnergy.setLineDash([5, 5]);
            ctxEnergy.beginPath();
            ctxEnergy.moveTo(0, threshY);
            ctxEnergy.lineTo(w, threshY);
            ctxEnergy.stroke();
            ctxEnergy.setLineDash([]);

            // ç»˜åˆ¶æ³¢å½¢
            // Solarized Blue
            ctxEnergy.strokeStyle = "#268bd2"; 
            ctxEnergy.lineWidth = 2;
            ctxEnergy.beginPath();
            
            smoothedEnergyData.forEach((db, i) => {
                const x = (i / smoothedEnergyData.length) * w;
                const y = mapY(db);
                if (i === 0) ctxEnergy.moveTo(x, y);
                else ctxEnergy.lineTo(x, y);
            });
            ctxEnergy.stroke();
        }

        function drawLabels() {
            const w = labelCanvas.width;
            const h = labelCanvas.height;
            ctxLabel.clearRect(0, 0, w, h);

            // èƒŒæ™¯
            ctxLabel.fillStyle = "#1f2937"; // gray-800
            ctxLabel.fillRect(0, 0, w, h);

            // ç»˜åˆ¶æ ‡ç­¾å—
            const blockWidth = w / binaryLabels.length;

            ctxLabel.fillStyle = "#cb4b16"; // green-500
            
            // ä¸ºäº†æ€§èƒ½ï¼Œåˆå¹¶ç›¸é‚»çš„çŸ©å½¢ç»˜åˆ¶
            let startI = -1;
            for(let i=0; i<binaryLabels.length; i++) {
                if (binaryLabels[i] === 1) {
                    if (startI === -1) startI = i;
                } else {
                    if (startI !== -1) {
                        // ç»˜åˆ¶ä¹‹å‰çš„æ®µ
                        const x = (startI / binaryLabels.length) * w;
                        const bw = ((i - startI) / binaryLabels.length) * w;
                        // åŠ ä¸€ç‚¹é¢å¤–çš„å®½åº¦ä»¥æ¶ˆé™¤ç¼éš™
                        ctxLabel.fillRect(x, 0, bw + 0.5, h);
                        startI = -1;
                    }
                }
            }
            // å¤„ç†ç»“å°¾
            if (startI !== -1) {
                const x = (startI / binaryLabels.length) * w;
                const bw = ((binaryLabels.length - startI) / binaryLabels.length) * w;
                ctxLabel.fillRect(x, 0, bw, h);
            }
        }

        // --- äº¤äº’å¾®è°ƒ ---

        let isDrawing = false;
        let drawMode = 1; // 1 = vocal, 0 = silence

        canvasWrapper.addEventListener('mousedown', (e) => {
            const rect = canvasWrapper.getBoundingClientRect();
            // æ³¨æ„ï¼šy åæ ‡ç°åœ¨éœ€è¦è€ƒè™‘åˆ° RulerCanvas çš„ 30px é«˜åº¦
            const y = e.clientY - rect.top + canvasWrapper.scrollTop;
            
            // å‡è®¾ Ruler 30, Energy 150, Label 50. Label Start at 180.
            if (y > 180) {
                isDrawing = true;
                drawMode = e.shiftKey ? 0 : 1; // Shift æ“¦é™¤
                modifyLabel(e);
            } else if (y > 30 && y < 180) {
                // ç‚¹å‡»åœ¨ Energy Canvas åŒºåŸŸï¼Œè·³è½¬æ’­æ”¾
                const x = e.clientX - rect.left + canvasWrapper.scrollLeft;
                const ratio = x / energyCanvas.width;
                if (audioBuffer && audioBuffer.duration) { // Check audioBuffer exists
                   const time = ratio * audioBuffer.duration;
                   seekAudio(time);
                }
            }
            // å¿½ç•¥ç‚¹å‡»åœ¨ Ruler Canvas (0-30px) åŒºåŸŸ
        });

        canvasWrapper.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                modifyLabel(e);
            }
        });

        window.addEventListener('mouseup', () => {
            if (isDrawing) {
                isDrawing = false;
                drawLabels(); // ç»“æŸæ—¶é‡ç»˜ç¡®ä¿æ¸…æ™°
            }
        });

        function modifyLabel(e) {
            const rect = canvasWrapper.getBoundingClientRect();
            const x = e.clientX - rect.left + canvasWrapper.scrollLeft;
            const w = labelCanvas.width;
            
            // æ˜ å°„ x åˆ°æ•°æ®ç´¢å¼•
            const index = Math.floor((x / w) * binaryLabels.length);
            
            if (index >= 0 && index < binaryLabels.length) {
                binaryLabels[index] = drawMode;
                
                requestAnimationFrame(drawLabels);
            }
        }

        // --- éŸ³é¢‘æ’­æ”¾ (ç•¥) ---

        function togglePlay() {
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        function playAudio() {
            if (!audioBuffer) return;
            
            audioSource = audioContext.createBufferSource();
            audioSource.buffer = audioBuffer;
            audioSource.connect(audioContext.destination);
            
            startTime = audioContext.currentTime - pauseTime;
            audioSource.start(0, pauseTime);
            isPlaying = true;
            document.getElementById('playPauseBtn').textContent = 'â¸';
            
            updatePlayhead();
        }

        function pauseAudio() {
            if (audioSource) {
                audioSource.stop();
                audioSource = null;
            }
            pauseTime = audioContext.currentTime - startTime;
            isPlaying = false;
            document.getElementById('playPauseBtn').textContent = 'â–¶';
        }

        function stopAudio() {
            if (audioSource) {
                audioSource.stop();
                audioSource = null;
            }
            isPlaying = false;
            pauseTime = 0;
            startTime = 0;
            updatePlayheadPosition(0);
            document.getElementById('playPauseBtn').textContent = 'â–¶';
        }

        function seekAudio(time) {
            const wasPlaying = isPlaying;
            if (isPlaying) pauseAudio();
            pauseTime = Math.max(0, Math.min(time, audioBuffer.duration));
            updatePlayheadPosition(pauseTime);
            if (wasPlaying) playAudio();
        }

        function updatePlayhead() {
            if (!isPlaying) return;
            
            const current = audioContext.currentTime - startTime;
            
            if (current >= audioBuffer.duration) {
                stopAudio();
                return;
            }
            
            updatePlayheadPosition(current);
            requestAnimationFrame(updatePlayhead);
        }

        function updatePlayheadPosition(time) {
            document.getElementById('currentTime').textContent = formatTime(time);
            
            // Fix: Check if audioBuffer exists before accessing duration
            if (!energyCanvas.width || !audioBuffer) return;
            
            const ratio = time / audioBuffer.duration;
            const x = ratio * energyCanvas.width;
            
            playhead.style.display = 'block';
            playhead.style.left = x + 'px';
            
            // è‡ªåŠ¨æ»šåŠ¨
            const containerW = canvasWrapper.clientWidth;
            const scrollLeft = canvasWrapper.scrollLeft;
            
            if (x > scrollLeft + containerW * 0.8) {
                canvasWrapper.scrollLeft = x - containerW * 0.2;
            } else if (x < scrollLeft) {
                canvasWrapper.scrollLeft = x - containerW * 0.2;
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 100);
            // åªæœ‰æ•´ç§’æ˜¾ç¤º 00:00.00
            if (seconds % 1 === 0) {
                 return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }
            // å¦åˆ™æ˜¾ç¤ºåˆ°å°æ•°ç‚¹åä¸¤ä½
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0').slice(0, 2)}`;
        }

        // --- å¯¼å‡ºåŠŸèƒ½ (ç•¥) ---

        function exportLabels() {
            if (!audioBuffer) return;
            
            // 1. åˆå¹¶è¿ç»­æ®µ
            const segments = [];
            let currentStart = -1;
            
            // è¿™é‡Œæˆ‘ä»¬åªå¯¼å‡º label=1 (äººå£°) çš„æ®µï¼Œæˆ–è€…å¯¼å‡ºå…¨éƒ¨
            // é€šå¸¸ Audacity åªéœ€è¦æ ‡æ³¨åŒºåŸŸã€‚æˆ‘ä»¬å¯¼å‡º äººå£°åŒºåŸŸã€‚
            
            for (let i = 0; i < binaryLabels.length; i++) {
                const label = binaryLabels[i];
                const time = i * dataStep;
                
                if (label === 1 && currentStart === -1) {
                    currentStart = time;
                } else if (label === 0 && currentStart !== -1) {
                    segments.push({
                        start: currentStart,
                        end: time,
                        label: 'Vocal'
                    });
                    currentStart = -1;
                }
            }
            // ç»“å°¾æ£€æŸ¥
            if (currentStart !== -1) {
                segments.push({
                    start: currentStart,
                    end: binaryLabels.length * dataStep,
                    label: 'Vocal'
                });
            }

            // 2. ç”Ÿæˆ Audacity æ ¼å¼æ–‡æœ¬ (Start	End	Label)
            let txtContent = "";
            segments.forEach(seg => {
                txtContent += `${seg.start.toFixed(6)}\t${seg.end.toFixed(6)}\t${seg.label}\n`;
            });

            // 3. ç”Ÿæˆ JSON
            const jsonContent = JSON.stringify({
                filename: fileList[currentFileIndex].name,
                duration: audioBuffer.duration,
                segments: segments,
                thresholdUsed: thresholdDb,
                smoothingUsed: smoothingMs,
                zoomUsed: pixelsPerSecond // NEW
            }, null, 2);

            // 4. ä¸‹è½½
            downloadFile(txtContent, 'labels.txt', 'text/plain');
            // downloadFile(jsonContent, 'labels.json', 'application/json'); 
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>